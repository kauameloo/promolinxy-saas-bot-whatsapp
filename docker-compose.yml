##############################
#         NETWORKS
##############################
networks:
  stack-network:
    driver: bridge

##############################
#         SERVICES
##############################
services:

  ###################################################
  # POSTGRES DO TYPEBOT
  ###################################################
  postgres-typebot:
    image: postgres:14
    restart: unless-stopped
    environment:
      POSTGRES_USER: typebot
      POSTGRES_PASSWORD: ${TYPEBOT_POSTGRES_PASSWORD:-typebotpass}
      POSTGRES_DB: typebot
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    networks:
      - stack-network

  ###################################################
  # POSTGRES DO SAAS
  ###################################################
  postgres-saas:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-saasbot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-saasbot123}
      POSTGRES_DB: ${POSTGRES_DB:-saasbot}
    ports:
      - "5433:5432"
    volumes:
      - ./postgres-saas:/var/lib/postgresql/data
      - ./scripts:/docker-entrypoint-initdb.d
    networks:
      - stack-network

  ###################################################
  # REDIS DO SAAS
  ###################################################
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    networks:
      - stack-network

  ###################################################
  # TYPEBOT BUILDER
  ###################################################
  typebot-builder:
    image: baptistearno/typebot-builder:latest
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://typebot:${TYPEBOT_POSTGRES_PASSWORD:-typebotpass}@postgres-typebot:5432/typebot
      ENCRYPTION_SECRET: ${TYPEBOT_ENCRYPTION_SECRET}
      NEXTAUTH_URL: ${TYPEBOT_NEXTAUTH_URL:-https://builder.promolinxy.online}
      NEXT_PUBLIC_VIEWER_URL: ${TYPEBOT_NEXT_PUBLIC_VIEWER_URL:-https://bot.promolinxy.online}
      NEXTAUTH_SECRET: ${TYPEBOT_NEXTAUTH_SECRET}
      GITHUB_CLIENT_ID: ${TYPEBOT_GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${TYPEBOT_GITHUB_CLIENT_SECRET:-}
    networks:
      - stack-network
    depends_on:
      - postgres-typebot

  ###################################################
  # TYPEBOT VIEWER
  ###################################################
  typebot-viewer:
    image: baptistearno/typebot-viewer:latest
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://typebot:${TYPEBOT_POSTGRES_PASSWORD:-typebotpass}@postgres-typebot:5432/typebot
      ENCRYPTION_SECRET: ${TYPEBOT_ENCRYPTION_SECRET}
      NEXTAUTH_URL: ${TYPEBOT_NEXTAUTH_URL:-https://builder.promolinxy.online}
      NEXT_PUBLIC_VIEWER_URL: ${TYPEBOT_NEXT_PUBLIC_VIEWER_URL:-https://bot.promolinxy.online}
      NEXTAUTH_SECRET: ${TYPEBOT_NEXTAUTH_SECRET}
    networks:
      - stack-network
    depends_on:
      - postgres-typebot

  ###################################################
  # N8N
  ###################################################
  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    environment:
      - N8N_HOST=n8n.promolinxy.online
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - GENERIC_TIMEZONE=America/Sao_Paulo
      - N8N_SECURE_COOKIE=false
      - N8N_RUNNERS_ENABLED=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
    ports:
      - "5678:5678"
    volumes:
      - ./n8n:/home/node/.n8n
    networks:
      - stack-network

  ###################################################
  # BACKEND SAAS (IMAGEM DO DOCKER HUB)
  ###################################################
  whatsapp-engine:
    image: kauameloo/saas-backend:latest
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-saasbot}:${POSTGRES_PASSWORD:-saasbot123}@postgres-saas:5432/${POSTGRES_DB:-saasbot}?sslmode=disable
      WHATSAPP_SESSION_PATH: /app/sessions
      WHATSAPP_PORT: 3001
      WHATSAPP_HOST: 0.0.0.0
      WHATSAPP_ENGINE_URL: https://backend.promolinxy.online
      QUEUE_STATS_PORT: 3002
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      PUPPETEER_ARGS: "--no-sandbox,--disable-setuid-sandbox,--disable-dev-shm-usage"
    ports:
      - "3001:3001"
      - "3002:3002"
    volumes:
      - whatsapp-sessions:/app/sessions
    depends_on:
      - postgres-saas
      - redis
    networks:
      - stack-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ###################################################
  # FRONTEND SAAS (Next.js)
  ###################################################
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://backend.promolinxy.online
      - DATABASE_URL=postgresql://${POSTGRES_USER:-saasbot}:${POSTGRES_PASSWORD:-saasbot123}@postgres-saas:5432/${POSTGRES_DB:-saasbot}?sslmode=disable
      - JWT_SECRET=${JWT_SECRET}
      - CAKTO_WEBHOOK_SECRET=${CAKTO_WEBHOOK_SECRET}
      - WHATSAPP_ENGINE_URL=http://whatsapp-engine:3001
    depends_on:
      - postgres-saas
      - whatsapp-engine
    networks:
      - stack-network

  ###################################################
  # CADDY (PROXY)
  ###################################################
  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy_data:/data
      - ./caddy_config:/config
    networks:
      - stack-network
    depends_on:
      - typebot-builder
      - typebot-viewer
      - frontend
      - whatsapp-engine
      - n8n

##############################
#          VOLUMES
##############################
volumes:
  redis-data:
  whatsapp-sessions:
